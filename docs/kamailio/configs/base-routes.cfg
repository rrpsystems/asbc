# =============================================
# ARQUIVO: base-routes.cfg
# Rotas de Sinalizações Padroes das chamadas
# =============================================

request_route {
    if ($rm == "OPTIONS" && $rU == "health") {
        route(HEALTH_CHECK);
        exit;
    }

    route(REQINIT);
    route(NATDETECT);

    if (is_method("CANCEL")) {
        if ($sht(call=>$ci::start_time) != $null) {
            $sht(call=>$ci::disposition) = "CANCELLED";
            $sht(call=>$ci::hangup) = "Origem";
            $sht(call=>$ci::hangup_code) = "487";
            $sht(call=>$ci::sip_code) = "487";
            $sht(call=>$ci::sip_reason) = "Request Terminated";
            $sht(call=>$ci::failure_type) = "CLIENT_ERROR";
        }

        if (t_check_trans()) {
            route(RELAY);
        }
        exit;
    }

    if (!is_method("ACK")) {
        if(t_precheck_trans()) {
            t_check_trans();
            exit;
        }
        t_check_trans();
    }

    route(WITHINDLG);
    remove_hf("Route");

    route(MAIN_ROUTE);
}

onreply_route {
    # Captura código e descrição SIP de TODAS as respostas
    $sht(call=>$ci::sip_code) = $rs;
    $sht(call=>$ci::sip_reason) = $rr;

    # Classifica tipo de falha baseado no código SIP
    if ($rs >= 600) {
        $sht(call=>$ci::failure_type) = "GLOBAL_FAILURE";
    } else if ($rs >= 500) {
        $sht(call=>$ci::failure_type) = "SERVER_ERROR";
    } else if ($rs >= 400) {
        $sht(call=>$ci::failure_type) = "CLIENT_ERROR";
    } else if ($rs >= 300) {
        $sht(call=>$ci::failure_type) = "REDIRECT";
    }

    if (has_body("application/sdp")) {
        if (status =~ "18[0-9]|2[0-9][0-9]") {
            rtpengine_answer("replace-origin replace-session-connection ICE=remove");
        }
    }

    if ($rs == "100" && $sht(call=>$ci::ip_dst) == $null) {
        $sht(call=>$ci::ip_dst) = $si;
    }

    if ($rs == "200" && is_method("INVITE")) {
        $sht(call=>$ci::answer_time) = $Ts;
        $sht(call=>$ci::disposition) = "ANSWERED";

        route(EXTRACT_CODEC_OUT);

        if ($avp(codec_origem) != $null) {
            $sht(call=>$ci::codec_in) = $avp(codec_origem);
        }
    }

    # Captura cabeçalho Reason e extrai Q.850 para falhas (3xx, 4xx, 5xx, 6xx)
    if ($rs >= 300) {
        $sht(call=>$ci::hangup_code) = $rs;
        $sht(call=>$ci::disposition) = "FAILED";

        if (is_present_hf("Reason")) {
            $sht(call=>$ci::reason_header) = $hdr(Reason);
            route(EXTRACT_Q850_CAUSE);
        }
    }
}

failure_route[MANAGE_FAILURE] {
    if (t_is_canceled()) {
        $sht(call=>$ci::hangup) = "Origem";
        $sht(call=>$ci::hangup_code) = "487";
        $sht(call=>$ci::sip_code) = "487";
        $sht(call=>$ci::sip_reason) = "Request Terminated";
        $sht(call=>$ci::disposition) = "CANCELLED";
        $sht(call=>$ci::failure_type) = "CLIENT_ERROR";
        route(SAVE_CDR);
        exit;
    }

    if (t_check_status("(4|5|6)[0-9][0-9]")) {
        $sht(call=>$ci::hangup_code) = $T_reply_code;
        $sht(call=>$ci::sip_code) = $T_reply_code;
        $sht(call=>$ci::sip_reason) = $T_reply_reason;
        $sht(call=>$ci::disposition) = "FAILED";
        $sht(call=>$ci::hangup) = "Destino";

        # Classifica tipo de falha
        if ($T_reply_code >= 600) {
            $sht(call=>$ci::failure_type) = "GLOBAL_FAILURE";
        } else if ($T_reply_code >= 500) {
            $sht(call=>$ci::failure_type) = "SERVER_ERROR";
        } else if ($T_reply_code >= 400) {
            $sht(call=>$ci::failure_type) = "CLIENT_ERROR";
        }

        route(SAVE_CDR);
    }

    exit;
}

event_route[dialog:start] {
    xlog("L_INFO", ">>> Dialog iniciado: $ci\n");
}

event_route[dialog:failed] {
    if ($sht(call=>$ci::start_time) != $null) {
        route(SAVE_CDR);
    }
}

event_route[dialog:end] {
    $var(hangup_origem) = $dlg_var(hangup_party);

    if ($var(hangup_origem) != $null && $var(hangup_origem) != "") {
        $sht(call=>$ci::hangup) = $var(hangup_origem);
    } else {
        if ($si == $sht(call=>$ci::ip_src)) {
            $sht(call=>$ci::hangup) = "Origem";
        } else {
            $sht(call=>$ci::hangup) = "Destino";
        }
    }

    if ($sht(call=>$ci::start_time) != $null) {
        route(SAVE_CDR);
    }
}

route[REQINIT] {
    set_reply_no_connect();
    force_rport();

    if ($ua =~ "friendly-scanner|sipcli|VaxSIPUserAgent|sipvicious|pplsip") {
        exit;
    }

    if(src_ip!=myself) {
        if($sht(ipban=>$si)!=$null) {
            exit;
        }
        if(!pike_check_req()) {
            exit;
        }
    }

    # OPTIONS das operadoras
    if(is_method("OPTIONS")) {
        sl_send_reply("200", "OK");
        exit;
    }

    if(!mf_process_maxfwd_header("10")) {
        sl_send_reply("483", "Too Many Hops");
        exit;
    }

    if(!sanity_check("17895","7")) {
        exit;
    }
}

route[WITHINDLG] {
    if(!has_totag()) return;

    if (loose_route()) {
        route(DLGURI);

        if (is_method("BYE")) {
            setflag(FLT_ACC);
            setflag(FLT_ACCFAILED);

            if ($si == $sht(call=>$ci::ip_src)) {
                $dlg_var(hangup_party) = "Origem";
            } else {
                $dlg_var(hangup_party) = "Destino";
            }

            if ($sht(call=>$ci::hangup_code) == $null) {
                $sht(call=>$ci::hangup_code) = "200";
            }

            # BYE normal: código SIP 200 OK
            if ($sht(call=>$ci::sip_code) == $null) {
                $sht(call=>$ci::sip_code) = "200";
                $sht(call=>$ci::sip_reason) = "OK";
            }

        } else if (is_method("ACK")) {
            route(NATMANAGE);

        } else if (is_method("NOTIFY|REFER|UPDATE")) {
            record_route();
        }

        route(RELAY);
        exit;
    }

    if (is_method("ACK")) {
        if (t_check_trans()) {
            route(NATMANAGE);
            exit;
        }
    }

    sl_send_reply("404", "Not here");
    exit;
}

route[NATDETECT] {
    if (nat_uac_test("19")) {
        if (is_method("REGISTER")) {
            fix_nated_register();
        } else {
            if (is_first_hop()) {
                set_contact_alias();
            }
        }
    }
    return;
}

route[NATMANAGE] {
    if (has_body("application/sdp")) {
        rtpengine_manage("replace-origin replace-session-connection ICE=remove");
    }

    if(nat_uac_test("19")) {
        rtpengine_manage("replace-origin replace-session-connection ICE=remove");
    }
    return;
}

route[DLGURI] {
    if(!isdsturiset()) handle_ruri_alias();
    return;
}

route[RELAY] {
    if (!t_relay()) {
        sl_reply_error();
    }
    exit;
}

route[HEALTH_CHECK] {
    $var(active) = $stat(active_dialogs);
    $var(status) = '{"status":"ok","active_calls":' + $var(active) + '}';
    send_reply("200", "$var(status)");
    exit;
}

route[MAIN_ROUTE] {
    if (!mf_process_maxfwd_header("10")) {
        sl_send_reply("483", "Too Many Hops");
        exit;
    }

    if ($Rp == 5060 || $Rp == 5090) {
        $sht(call=>$ci::tipo) = "Entrada";
    } else if ($Rp == 5080) {
        $sht(call=>$ci::tipo) = "Saida";
    } else {
        $sht(call=>$ci::tipo) = "Desconhecido";
    }

    if (is_method("REGISTER")) {
        if (!save("location")) {
            sl_reply_error();
        }
        exit;
    }

    if (is_method("INVITE")) {
        if (!has_totag()) {
            if (!t_newtran()) {
                sl_reply_error();
                exit;
            }

            $sht(call=>$ci::start_time) = $Ts;
            $sht(call=>$ci::src) = $fU;
            $sht(call=>$ci::dst) = $rU;
            $sht(call=>$ci::ip_src) = $si;
            $sht(call=>$ci::user_agent) = $ua;
            $sht(call=>$ci::ramal) = $hdr(Extension);

            route(EXTRACT_CODEC_IN);

            setflag(FLT_DIALOG);
            dlg_manage();
            t_on_failure("MANAGE_FAILURE");
        }

        if($sht(call=>$ci::tipo) == "Entrada") {
            route(ENTRADA_BILLING);
        } else if($sht(call=>$ci::tipo) == "Saida") {
            route(SAIDA_BILLING);
        } else {
            route(NATMANAGE);
            if (!t_relay()) {
                sl_reply_error();
            }
        }

        exit;

    } else {
        route(NATMANAGE);
        if (!t_relay()) {
            sl_reply_error();
        }
    }

    exit;
}

route[EXTRACT_CODEC_IN] {
    if (!has_body("application/sdp")) return;

    if (sdp_get_line_startswith("$avp(mline)", "m=audio")) {
        $var(payload) = $(avp(mline){re.subst,/m=audio [0-9]+ [A-Z\/]+ ([0-9]+).*/\1/});

        if ($var(payload) =~ "^[0-9]+$") {
            $avp(prefixo) = "a=rtpmap:" + $var(payload);

            if (sdp_get_line_startswith("$avp(rtpmap)", "$avp(prefixo)")) {
                 $sht(call=>$ci::codec_in) = $(avp(rtpmap){re.subst,/a=rtpmap:[0-9]+ ([a-zA-Z0-9-]+)\/.*/\1/});
            } else {
                 if ($var(payload) == "0") $sht(call=>$ci::codec_in) = "PCMU";
                 else if ($var(payload) == "8") $sht(call=>$ci::codec_in) = "PCMA";
                 else if ($var(payload) == "18") $sht(call=>$ci::codec_in) = "G729";
                 else if ($var(payload) == "9") $sht(call=>$ci::codec_in) = "G722";
                 else $sht(call=>$ci::codec_in) = "Unknown-" + $var(payload);
            }
        }
    }

    if (sdp_get_line_startswith("$avp(cline)", "c=")) {
        $sht(call=>$ci::ip_rtp_src) = $(avp(cline){re.subst,/c=IN IP4 ([0-9.]+).*/\1/});
    }

    $avp(codec_origem) = $sht(call=>$ci::codec_in);

    return;
}

route[EXTRACT_CODEC_OUT] {
    if (!has_body("application/sdp")) return;

    if (sdp_get_line_startswith("$avp(mline)", "m=audio")) {
        $var(payload) = $(avp(mline){re.subst,/m=audio [0-9]+ [A-Z\/]+ ([0-9]+).*/\1/});

        if ($var(payload) =~ "^[0-9]+$") {
            $avp(prefixo) = "a=rtpmap:" + $var(payload);

            if (sdp_get_line_startswith("$avp(rtpmap)", "$avp(prefixo)")) {
                 $sht(call=>$ci::codec_out) = $(avp(rtpmap){re.subst,/a=rtpmap:[0-9]+ ([a-zA-Z0-9-]+)\/.*/\1/});
            } else {
                 if ($var(payload) == "0") $sht(call=>$ci::codec_out) = "PCMU";
                 else if ($var(payload) == "8") $sht(call=>$ci::codec_out) = "PCMA";
                 else if ($var(payload) == "18") $sht(call=>$ci::codec_out) = "G729";
                 else if ($var(payload) == "9") $sht(call=>$ci::codec_out) = "G722";
                 else $sht(call=>$ci::codec_out) = "Unknown-" + $var(payload);
            }
        }
    }

    if (sdp_get_line_startswith("$avp(cline)", "c=")) {
        $sht(call=>$ci::ip_rtp_dst) = $(avp(cline){re.subst,/c=IN IP4 ([0-9.]+).*/\1/});
    }
}

# =============================================
# EXTRAÇÃO DE Q.850 CAUSE DO CABEÇALHO REASON
# =============================================
route[EXTRACT_Q850_CAUSE] {
    # Exemplo de cabeçalho Reason:
    # Reason: Q.850;cause=16;text="Normal call clearing"
    # Reason: SIP;cause=404;text="Not Found"

    $var(reason) = $sht(call=>$ci::reason_header);

    # Verifica se é causa Q.850
    if ($var(reason) =~ "Q\.850") {
        # Extrai o código de causa (número após cause=)
        if ($var(reason) =~ "cause=([0-9]+)") {
            $sht(call=>$ci::q850_cause) = $(var(reason){re.subst,/.*cause=([0-9]+).*/\1/});
            route(TRANSLATE_Q850);
        }
    }
    # Verifica se é causa SIP no cabeçalho Reason
    else if ($var(reason) =~ "SIP") {
        if ($var(reason) =~ "cause=([0-9]+)") {
            $var(sip_cause) = $(var(reason){re.subst,/.*cause=([0-9]+).*/\1/});
            # Se vier causa SIP no Reason, mas não temos SIP code ainda, usa ela
            if ($sht(call=>$ci::sip_code) == $null) {
                $sht(call=>$ci::sip_code) = $var(sip_cause);
            }
        }
    }

    return;
}

# =============================================
# TRADUÇÃO DE Q.850 CAUSE PARA DESCRIÇÃO
# =============================================
route[TRANSLATE_Q850] {
    $var(cause) = $sht(call=>$ci::q850_cause);

    # Códigos Q.850 mais comuns
    if ($var(cause) == "1") $sht(call=>$ci::q850_description) = "Unallocated number";
    else if ($var(cause) == "2") $sht(call=>$ci::q850_description) = "No route to network";
    else if ($var(cause) == "3") $sht(call=>$ci::q850_description) = "No route to destination";
    else if ($var(cause) == "16") $sht(call=>$ci::q850_description) = "Normal call clearing";
    else if ($var(cause) == "17") $sht(call=>$ci::q850_description) = "User busy";
    else if ($var(cause) == "18") $sht(call=>$ci::q850_description) = "No user responding";
    else if ($var(cause) == "19") $sht(call=>$ci::q850_description) = "No answer from user";
    else if ($var(cause) == "20") $sht(call=>$ci::q850_description) = "Subscriber absent";
    else if ($var(cause) == "21") $sht(call=>$ci::q850_description) = "Call rejected";
    else if ($var(cause) == "22") $sht(call=>$ci::q850_description) = "Number changed";
    else if ($var(cause) == "23") $sht(call=>$ci::q850_description) = "Redirected to new destination";
    else if ($var(cause) == "26") $sht(call=>$ci::q850_description) = "Non-selected user clearing";
    else if ($var(cause) == "27") $sht(call=>$ci::q850_description) = "Destination out of order";
    else if ($var(cause) == "28") $sht(call=>$ci::q850_description) = "Invalid number format";
    else if ($var(cause) == "29") $sht(call=>$ci::q850_description) = "Facility rejected";
    else if ($var(cause) == "31") $sht(call=>$ci::q850_description) = "Normal, unspecified";
    else if ($var(cause) == "34") $sht(call=>$ci::q850_description) = "No circuit/channel available";
    else if ($var(cause) == "38") $sht(call=>$ci::q850_description) = "Network out of order";
    else if ($var(cause) == "41") $sht(call=>$ci::q850_description) = "Temporary failure";
    else if ($var(cause) == "42") $sht(call=>$ci::q850_description) = "Switching equipment congestion";
    else if ($var(cause) == "44") $sht(call=>$ci::q850_description) = "Requested channel not available";
    else if ($var(cause) == "47") $sht(call=>$ci::q850_description) = "Resource unavailable";
    else if ($var(cause) == "50") $sht(call=>$ci::q850_description) = "Requested facility not subscribed";
    else if ($var(cause) == "57") $sht(call=>$ci::q850_description) = "Bearer capability not authorized";
    else if ($var(cause) == "58") $sht(call=>$ci::q850_description) = "Bearer capability not presently available";
    else if ($var(cause) == "63") $sht(call=>$ci::q850_description) = "Service or option not available";
    else if ($var(cause) == "65") $sht(call=>$ci::q850_description) = "Bearer capability not implemented";
    else if ($var(cause) == "79") $sht(call=>$ci::q850_description) = "Service or option not implemented";
    else if ($var(cause) == "88") $sht(call=>$ci::q850_description) = "Incompatible destination";
    else if ($var(cause) == "102") $sht(call=>$ci::q850_description) = "Recovery on timer expiry";
    else if ($var(cause) == "111") $sht(call=>$ci::q850_description) = "Protocol error, unspecified";
    else if ($var(cause) == "127") $sht(call=>$ci::q850_description) = "Interworking, unspecified";
    else $sht(call=>$ci::q850_description) = "Unknown Q.850 cause";

    return;
}

route[CONTROLE_CANAIS] {
    if ($sht(call=>$ci::customer_id) == $null) return;

    if ($sht(cust_chan=>$sht(call=>$ci::customer_id)) >= $sht(call=>$ci::limite_customer_channels)) {
        sl_send_reply("486", "Limite de canais atingido");
        $sht(call=>$ci::disposition) = "FAILED";
        $sht(call=>$ci::hangup_code) = "486";
        $sht(call=>$ci::sip_code) = "486";
        $sht(call=>$ci::sip_reason) = "Busy Here";
        $sht(call=>$ci::failure_type) = "CLIENT_ERROR";
        route(SAVE_CDR);
        exit;
    }

    if($sht(cust_chan=>$sht(call=>$ci::customer_id)) > 0) {
        $sht(cust_chan=>$sht(call=>$ci::customer_id)) = $shtinc(cust_chan=>$sht(call=>$ci::customer_id));
    } else {
        $sht(cust_chan=>$sht(call=>$ci::customer_id)) = 1;
    }
    $dlg_var(cliente_id) = "" + $sht(call=>$ci::customer_id);
    $dlg_var(canal_incrementado) = "1";
}

route[DECREMENTA_CANAIS] {
    $var(cliente_id) = $dlg_var(cliente_id);
    $var(incrementado) = $dlg_var(canal_incrementado);

    if($var(cliente_id) != $null && $var(incrementado) == "1") {
        if($sht(cust_chan=>$var(cliente_id)) > 0) {
            $sht(cust_chan=>$var(cliente_id)) = $shtdec(cust_chan=>$var(cliente_id));
        }
        $dlg_var(canal_incrementado) = "0";
    }
}

route[CONTROLE_CANAIS_CARRIER] {
    if ($sht(call=>$ci::carrier_id) == $null) return;

    if ($sht(carr_chan=>$sht(call=>$ci::carrier_id)) >= $sht(call=>$ci::limite_carrier_channels)) {
        sl_send_reply("503", "Carrier sem canais");
        $sht(call=>$ci::disposition) = "FAILED";
        $sht(call=>$ci::hangup_code) = "503";
        $sht(call=>$ci::sip_code) = "503";
        $sht(call=>$ci::sip_reason) = "Service Unavailable";
        $sht(call=>$ci::failure_type) = "SERVER_ERROR";
        route(SAVE_CDR);
        exit;
    }

    if($sht(carr_chan=>$sht(call=>$ci::carrier_id)) > 0) {
        $sht(carr_chan=>$sht(call=>$ci::carrier_id)) = $shtinc(carr_chan=>$sht(call=>$ci::carrier_id));
    } else {
        $sht(carr_chan=>$sht(call=>$ci::carrier_id)) = 1;
    }
    $dlg_var(carrier_id) = "" + $sht(call=>$ci::carrier_id);
    $dlg_var(carrier_canal_incrementado) = "1";
}

route[DECREMENTA_CANAIS_CARRIER] {
    $var(carrier_id) = $dlg_var(carrier_id);
    $var(incrementado) = $dlg_var(carrier_canal_incrementado);

    if($var(carrier_id) != $null && $var(incrementado) == "1") {
        if($sht(carr_chan=>$var(carrier_id)) > 0) {
            $sht(carr_chan=>$var(carrier_id)) = $shtdec(carr_chan=>$var(carrier_id));
        }
        $dlg_var(carrier_canal_incrementado) = "0";
    }
}

route[SAVE_CDR] {
    if ($sht(call=>$ci::cdr_saved) == "1") return;
    $sht(call=>$ci::cdr_saved) = "1";

    if ($sht(call=>$ci::disposition) == $null) {
        if ($sht(call=>$ci::answer_time) > 0) $sht(call=>$ci::disposition) = "ANSWERED";
        else $sht(call=>$ci::disposition) = "NO ANSWER";
    };

    if ($sht(call=>$ci::hangup) == $null) $sht(call=>$ci::hangup) = "Kamailio";

    if ($sht(call=>$ci::hangup_code) == $null) $sht(call=>$ci::hangup_code) = "200";

    # Se não temos SIP code ainda, usa o hangup_code
    if ($sht(call=>$ci::sip_code) == $null) {
        $sht(call=>$ci::sip_code) = $sht(call=>$ci::hangup_code);
        if ($sht(call=>$ci::hangup_code) == "200") {
            $sht(call=>$ci::sip_reason) = "OK";
        }
    }

    if($sht(call=>$ci::start_time) > 0) $sht(call=>$ci::duration) = $Ts - $sht(call=>$ci::start_time);
    else $sht(call=>$ci::duration) = 0;

    if($sht(call=>$ci::answer_time) > 0) $sht(call=>$ci::billsec) = $Ts - $sht(call=>$ci::answer_time);
    else $sht(call=>$ci::billsec) = 0;

    $var(sql_date) = "NULL";
    if ($sht(call=>$ci::start_time) != $null) {
        $var(sql_date) = "to_timestamp(" + $sht(call=>$ci::start_time) + ")::timestamp(0)";
    };

    $var(channel_src) = "SIP/" + $si;
    $var(channel_dst) = "SIP/" + $sht(call=>$ci::ip_dst);

    if ($sht(call=>$ci::codec_in) == $sht(call=>$ci::codec_out)) {
        $sht(call=>$ci::codec_nativo) = "By-Pass";
    } else {
        $sht(call=>$ci::codec_nativo) = "Translate";
    };

    # Prepara valores SQL com escape para campos de texto
    $var(sip_reason_sql) = "NULL";
    if ($sht(call=>$ci::sip_reason) != $null) {
        $var(sip_reason_sql) = "'" + $sht(call=>$ci::sip_reason) + "'";
    }

    $var(q850_desc_sql) = "NULL";
    if ($sht(call=>$ci::q850_description) != $null) {
        $var(q850_desc_sql) = "'" + $sht(call=>$ci::q850_description) + "'";
    }

    $var(reason_hdr_sql) = "NULL";
    if ($sht(call=>$ci::reason_header) != $null) {
        $var(reason_hdr_sql) = "'" + $sht(call=>$ci::reason_header) + "'";
    }

    $var(failure_type_sql) = "NULL";
    if ($sht(call=>$ci::failure_type) != $null) {
        $var(failure_type_sql) = "'" + $sht(call=>$ci::failure_type) + "'";
    }

    sql_query("pc", "INSERT INTO public.cdrs ("
        "calldate, clid, src, dst, dcontext, channel, dstchannel, lastapp, lastdata, "
        "duration, billsec, disposition, uniqueid, customer_id, carrier_id, did_id, "
        "tarifa, tipo, carrier_channels, customer_channels, desligamento, "
        "ip_src, ip_dst, ip_rtp_src, ip_rtp_dst, codec_nativo, codec_in, codec_out, hangup, "
        "numero, numero_discado, numero_convertido, ramal, "
        "sip_code, sip_reason, q850_cause, q850_description, reason_header, failure_type) VALUES ("
        "$var(sql_date), "
        "'$sht(call=>$ci::clid)', "
        "'$sht(call=>$ci::src)', "
        "'$sht(call=>$ci::dst)', "
        "'$sht(call=>$ci::dcontext)', "
        "'$var(channel_src)', "
        "'$var(channel_dst)', "
        "'Kamailio', "
        "'$rU', "
        "$sht(call=>$ci::duration), "
        "$sht(call=>$ci::billsec), "
        "'$sht(call=>$ci::disposition)', "
        "'$ci', "
        "'$sht(call=>$ci::customer_id)', "
        "'$sht(call=>$ci::carrier_id)', "
        "$sht(call=>$ci::did_id), "
        "'$sht(call=>$ci::tarifa)', "
        "'$sht(call=>$ci::tipo)', "
        "'$sht(carr_chan=>$sht(call=>$ci::carrier_id))', "
        "'$sht(cust_chan=>$sht(call=>$ci::customer_id))', "
        "'$sht(call=>$ci::hangup)', "
        "'$sht(call=>$ci::ip_src)', "
        "'$sht(call=>$ci::ip_dst)', "
        "'$sht(call=>$ci::ip_rtp_src)', "
        "'$sht(call=>$ci::ip_rtp_dst)', "
        "'$sht(call=>$ci::codec_nativo)', "
        "'$sht(call=>$ci::codec_in)', "
        "'$sht(call=>$ci::codec_out)', "
        "'$sht(call=>$ci::hangup_code)', "
        "'$sht(call=>$ci::numero)', "
        "'$sht(call=>$ci::numero_discado)', "
        "'$sht(call=>$ci::numero_convertido)', "
        "'$sht(call=>$ci::ramal)', "
        "'$sht(call=>$ci::sip_code)', "
        "$var(sip_reason_sql), "
        "'$sht(call=>$ci::q850_cause)', "
        "$var(q850_desc_sql), "
        "$var(reason_hdr_sql), "
        "$var(failure_type_sql))");

    route(DECREMENTA_CANAIS);
    route(DECREMENTA_CANAIS_CARRIER);

    $sht(call=>$ci::start_time) = $null;
    $sht(call=>$ci::src) = $null;
    $sht(call=>$ci::dst) = $null;
    $sht(call=>$ci::ip_src) = $null;
    $sht(call=>$ci::ip_dst) = $null;
    $sht(call=>$ci::ip_rtp_src) = $null;
    $sht(call=>$ci::ip_rtp_dst) = $null;
    $sht(call=>$ci::codec_nativo) = $null;
    $sht(call=>$ci::codec_in) = $null;
    $sht(call=>$ci::codec_out) = $null;
    $sht(call=>$ci::disposition) = $null;
    $sht(call=>$ci::hangup) = $null;
    $sht(call=>$ci::hangup_code) = $null;
    $sht(call=>$ci::answer_time) = $null;
    $sht(call=>$ci::duration) = $null;
    $sht(call=>$ci::billsec) = $null;
    $sht(call=>$ci::customer_id) = $null;
    $sht(call=>$ci::carrier_id) = $null;
    $sht(call=>$ci::tarifa) = $null;
    $sht(call=>$ci::tipo) = $null;
    $sht(call=>$ci::clid) = $null;
    $sht(call=>$ci::dcontext) = $null;
    $sht(call=>$ci::uniqueid) = $null;
    $sht(call=>$ci::numero) = $null;
    $sht(call=>$ci::numero_discado) = $null;
    $sht(call=>$ci::numero_convertido) = $null;
    $sht(call=>$ci::limite_carrier_channels) = $null;
    $sht(call=>$ci::limite_customer_channels) = $null;
    $sht(call=>$ci::cdr_saved) = $null;
    $sht(call=>$ci::user_agent) = $null;
    $sht(call=>$ci::q850_cause) = $null;
    $sht(call=>$ci::did_id) = $null;
    $sht(call=>$ci::ramal) = $null;
    $sht(call=>$ci::sip_code) = $null;
    $sht(call=>$ci::sip_reason) = $null;
    $sht(call=>$ci::q850_description) = $null;
    $sht(call=>$ci::reason_header) = $null;
    $sht(call=>$ci::failure_type) = $null;
    $sht(call=>$ci) = $null;

    return;
}
