# =============================================
# ARQUIVO: calls-out.cfg
# Saida de chamadas do pabx para a operadora
# =============================================

route[SAIDA_BILLING] {
    $sht(call=>$ci::dcontext) = "did_out";
    $sht(call=>$ci::uniqueid) = $ci;

    route(PROCESSAR_SAIDA);
    route(SET_CDR_OUT);

    if ($sht(call=>$ci::is_blocked) == "1") {
        route(PLAY_BLOCKED_OUT);
        exit;
    }

    route(SAIDA_DIAL);
    return;
}

route[SAIDA_DIAL]{
    $rU = $sht(call=>$ci::numero_convertido);

    $var(display_name) = $avp(razaosocial);

    # ✅ IMPORTANTE: Substitua 136.248.101.53 pelo seu IP público do SBC
    uac_replace_from("$var(display_name)", "sip:$fU@SEU_IP_PUBLICO_AQUI");
    uac_replace_to("", "sip:$sht(call=>$ci::numero_convertido)@$avp(proxy)");

    remove_hf("Remote-Party-ID");
    remove_hf("P-Preferred-Identity");
    remove_hf("X-FS-Support");

    # ✅ IMPORTANTE: Substitua 136.248.101.53 pelo seu IP público do SBC
    append_hf("P-Asserted-Identity: \"$var(display_name)\" <sip:$fU@SEU_IP_PUBLICO_AQUI>\r\n");

    if (has_body("application/sdp")) {
        rtpengine_manage("replace-origin replace-session-connection ICE=remove " +
                         "direction=internal direction=external " +
                         "codec-transcode-PCMA codec-transcode-PCMU " +
                         "codec-transcode-G729 codec-transcode-telephone-event " +
                         "silence-suppression=off");
    }

    $du = "sip:" + $avp(proxy) + ":" + $avp(porta);

    if (is_method("INVITE") || is_method("SUBSCRIBE")) {
        record_route();
    }

    t_relay();
    return;
}

route[SET_CDR_OUT] {
    if ($sht(did_cache=>$fU) != $null ) {
        $var(cached) = $sht(did_cache=>$fU);
        $sht(call=>$ci::customer_id) = $(var(cached){s.select,0,|});
        $sht(call=>$ci::carrier_id) = $(var(cached){s.select,1,|});
        $avp(operadora) = $(var(cached){s.select,2,|});
        $sht(call=>$ci::limite_carrier_channels) = $(var(cached){s.select,3,|});
        $avp(razaosocial) = $(var(cached){s.select,4,|});
        $sht(call=>$ci::limite_customer_channels) = $(var(cached){s.select,5,|});
        $avp(proxy) = $(var(cached){s.select,6,|});
        $avp(porta) = $(var(cached){s.select,7,|});
        $sht(call=>$ci::is_blocked) = $(var(cached){s.select,8,|});

        $sht(call=>$ci::did_id) = $fU;
        $sht(call=>$ci::clid) = $avp(razaosocial) + " <" + $fU + ">";
    } else {
        $var(safe_did) = $(fU{s.escape.common});

        sql_query("pc",
            "SELECT d.customer_id, d.carrier_id, LOWER(ca.operadora),
                    ca.canais, cu.razaosocial, cu.canais, ca.proxy, ca.porta, cu.bloqueio_saida::int
            FROM dids d
            JOIN customers cu ON d.customer_id = cu.id
            JOIN carriers ca ON d.carrier_id = ca.id
            WHERE d.did = '$var(safe_did)' AND d.ativo = 'true' AND cu.ativo = 'true' LIMIT 1", "customer");

        if ($dbr(customer=>rows) == 0) {
            t_reply("404", "DID nao cadastrado");
            sql_result_free("customer");
            exit;
        }

        $sht(call=>$ci::customer_id) = $dbr(customer=>[0,0]);
        $sht(call=>$ci::carrier_id) = $dbr(customer=>[0,1]);
        $avp(operadora) = $dbr(customer=>[0,2]);
        $sht(call=>$ci::limite_carrier_channels) = $dbr(customer=>[0,3]);
        $avp(razaosocial) = $dbr(customer=>[0,4]);
        $sht(call=>$ci::limite_customer_channels) = $dbr(customer=>[0,5]);
        $avp(proxy) = $dbr(customer=>[0,6]);
        $avp(porta) = $dbr(customer=>[0,7]);
        $sht(call=>$ci::clid) = $dbr(customer=>[0,4]) + " <" + $fU + ">";
        $sht(call=>$ci::did_id) = $fU;
        $sht(call=>$ci::is_blocked) = $dbr(customer=>[0,8]);

        $var(cache_val) = $dbr(customer=>[0,0]) + "|" + $dbr(customer=>[0,1]) + "|" +
                          $dbr(customer=>[0,2]) + "|" + $dbr(customer=>[0,3]) + "|" +
                          $dbr(customer=>[0,4]) + "|" + $dbr(customer=>[0,5]) + "|" +
                          $dbr(customer=>[0,6]) + "|" + $dbr(customer=>[0,7]) + "|" +
                          $dbr(customer=>[0,8]);
        $sht(did_cache=>$fU) = $var(cache_val);

        sql_result_free("customer");
    }

    route(CONTROLE_CANAIS);
    route(CONTROLE_CANAIS_CARRIER);
    return;
}

route[PROCESSAR_SAIDA] {
    $var(numero_original) = $rU;
    $sht(call=>$ci::numero_discado) = $rU;

    # ========================================================================
    # REGRAS DE NUMERAÇÃO BRASILEIRA (ANATEL)
    # Formato recebido do PABX: 55 + DDD (2 dígitos) + Número
    # ========================================================================

    # 1. SERVIÇOS (3, 4 ou 5 dígitos começando com 1)
    # - 3 dígitos: 100-199 (ex: 190, 192, 193)
    # - 4 dígitos: 1300-1999 (ex: 1301, 1331, 1400)
    # - 5 dígitos: 10000-10999 (ex: 10315, 10321)
    if ($var(numero_original) =~ "^55[0-9]{2}1[0-9]{2}$") {
        # 3 dígitos: 55XX1YY (ex: 5511190)
        route(SERVICO);
    } else if ($var(numero_original) =~ "^55[0-9]{2}1[3-9][0-9]{2}$") {
        # 4 dígitos: 55XX1[3-9]YY (ex: 55131331)
        route(SERVICO);
    } else if ($var(numero_original) =~ "^55[0-9]{2}10[0-9]{3}$") {
        # 5 dígitos: 55XX10YYY (ex: 551310315)
        route(SERVICO);

    # 2. 0300 e 0800 (Números especiais)
    } else if ($var(numero_original) =~ "^55(300|800)[0-9]+$") {
        $var(prefix) = $(var(numero_original){re.subst,/^55(300|800).*/\1/});
        if ($var(prefix) == "300") route(TARIFA_0300);
        else route(TARIFA_0800);

    # 3. FIXO (começa com 2-5, tem 7 ou 8 dígitos)
    # Exemplos: 55XX2XXX-XXXX, 55XX3XXX-XXX
    } else if ($var(numero_original) =~ "^55[0-9]{2}[2-5][0-9]{6,7}$") {
        route(TARIFA_FIXO);

    # 4. MÓVEL (começa com 6-9, obrigatoriamente 9 dígitos)
    # Exemplos: 55XX9XXXX-XXXX
    } else if ($var(numero_original) =~ "^55[0-9]{2}[6-9][0-9]{8}$") {
        route(TARIFA_MOVEL);

    # 5. INTERNACIONAL (00 + código país + número)
    } else if ($var(numero_original) =~ "^00[0-9]{8,}$") {
        route(TARIFA_INTERNACIONAL);

    # 6. NÚMERO INVÁLIDO
    } else {
        xlog("L_WARN", ">>> NUMERO INVALIDO: $var(numero_original)\n");
        sl_send_reply("404", "Numero invalido");
        exit;
    }
    return;
}

route[SERVICO] {
    # Remove 55 + DDD (primeiros 4 caracteres)
    # Exemplos:
    # - 5511190 -> 190
    # - 55131331 -> 1331
    # - 551310315 -> 10315
    $sht(call=>$ci::numero) = $(var(numero_original){s.substr,4,0});
    $sht(call=>$ci::numero_convertido) = $(var(numero_original){s.substr,4,0});
    $sht(call=>$ci::tarifa) = "Servico";
    xlog("L_INFO", ">>> SERVICO: $var(numero_original) -> $sht(call=>$ci::numero_convertido)\n");
    return;
}

route[TARIFA_0300] {
    # 550300XXXXX -> 00300XXXXX
    $var(temp) = $(var(numero_original){s.substr,2,0});
    $sht(call=>$ci::numero) = "0" + $var(temp);
    $sht(call=>$ci::numero_convertido) = "0" + $var(temp);
    $sht(call=>$ci::tarifa) = "Fixo";
    return;
}

route[TARIFA_0800] {
    # 550800XXXXX -> 00800XXXXX
    $var(temp) = $(var(numero_original){s.substr,2,0});
    $sht(call=>$ci::numero) = "0" + $var(temp);
    $sht(call=>$ci::numero_convertido) = "0" + $var(temp);
    $sht(call=>$ci::tarifa) = "Gratuito";
    return;
}

route[TARIFA_FIXO] {
    $var(ddd_origem) = $(fU{s.substr,0,2});
    $var(ddd_destino) = $(var(numero_original){s.substr,2,2});

    if ($var(ddd_origem) == $var(ddd_destino)) {
        # Mesma área: remove 55+DDD, envia só o número
        # 5511XXXX-XXXX -> XXXX-XXXX
        $sht(call=>$ci::numero) = $(var(numero_original){s.substr,2,0});
        $sht(call=>$ci::numero_convertido) = $(var(numero_original){s.substr,4,0});
    } else {
        # Áreas diferentes: 0 + CSP (12) + DDD + número
        # 5511XXXX-XXXX -> 012 11 XXXX-XXXX
        $var(temp) = $(var(numero_original){s.substr,2,0});
        $sht(call=>$ci::numero) = $var(temp);
        $sht(call=>$ci::numero_convertido) = "012" + $var(temp);
    }
    $sht(call=>$ci::tarifa) = "Fixo";
    return;
}

route[TARIFA_MOVEL] {
    $var(ddd_origem) = $(fU{s.substr,0,2});
    $var(ddd_destino) = $(var(numero_original){s.substr,2,2});

    if ($var(ddd_origem) == $var(ddd_destino)) {
        # Mesma área: remove 55+DDD, envia só o número
        # 55119XXXX-XXXX -> 9XXXX-XXXX
        $sht(call=>$ci::numero) = $(var(numero_original){s.substr,2,0});
        $sht(call=>$ci::numero_convertido) = $(var(numero_original){s.substr,4,0});
    } else {
        # Áreas diferentes: 0 + CSP (12) + DDD + número
        # 55119XXXX-XXXX -> 012 11 9XXXX-XXXX
        $var(temp) = $(var(numero_original){s.substr,2,0});
        $sht(call=>$ci::numero) = $var(temp);
        $sht(call=>$ci::numero_convertido) = "012" + $var(temp);
    }
    $sht(call=>$ci::tarifa) = "Movel";
    return;
}

route[TARIFA_INTERNACIONAL] {
    # 001155... -> 0012 1155...
    $sht(call=>$ci::numero_convertido) = "0012" + $(var(numero_original){s.substr,2,0});
    $sht(call=>$ci::tarifa) = "Internacional";
    return;
}
