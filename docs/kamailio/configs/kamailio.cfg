#!KAMAILIO

# ==================================================================
# ARQUIVO DE CONFIGURAÇÃO PRINCIPAL DO KAMAILIO
# ==================================================================
#
# IMPORTANTE: Antes de usar este arquivo, ajuste as seguintes variáveis:
#
# 1. PUBLIC_IP (linha 34): Substitua pelo seu IP público real
# 2. listen/advertise (linhas 49-56): Substitua pelos seus IPs
# 3. alias (linhas 58-60): Substitua pelos seus IPs
# 4. String de conexão PostgreSQL (linha 130): Ajuste usuário, senha e banco
#
# ==================================================================

####### Include Local Config If Exists #########
import_file "kamailio-local.cfg"

####### DEFINES #########
#!ifdef WITH_DEBUG
#!define DBGLEVEL 3
#!else
#!define DBGLEVEL 2
#!endif
#!define WITH_NAT
#!define WITH_RTPENGINE
#!define WITH_ANTIFLOOD

#!ifdef WITH_MULTIDOMAIN
#!define MULTIDOMAIN 1
#!else
#!define MULTIDOMAIN 0
#!endif

#!ifdef WITH_ANTIFLOOD
#!trydef WITH_HTABLE
#!endif

# - flags
#!define FLT_ACC 1
#!define FLT_ACCMISSED 2
#!define FLT_ACCFAILED 3
#!define FLT_DIALOG 4
#!define FLT_NATS 5

# FLB_ - per branch flags
#!define FLB_NATB 6
#!define FLB_NATSIPPING 7

# ✅ IMPORTANTE: Substitua pelo seu IP público real
#!define PUBLIC_IP "SEU_IP_PUBLICO_AQUI"

####### GLOBAL PARAMETERS #########
debug=DBGLEVEL
log_stderror=no
memdbg=5
memlog=5
log_facility=LOG_LOCAL0
log_prefix="{$mt $hdr(CSeq) $ci} "

children=8

# ✅ OTIMIZAÇÃO: Aumentar conexões TCP
tcp_connection_lifetime=3605
tcp_max_connections=8192
tcp_accept_no_cl=yes

# ✅ IMPORTANTE: Substitua SEU_IP_PUBLICO_AQUI pelo seu IP público real
# Listen sockets
listen=udp:0.0.0.0:5060 advertise SEU_IP_PUBLICO_AQUI:5060
listen=tcp:0.0.0.0:5060 advertise SEU_IP_PUBLICO_AQUI:5060
listen=udp:0.0.0.0:5090 advertise SEU_IP_PUBLICO_AQUI:5090
listen=tcp:0.0.0.0:5090 advertise SEU_IP_PUBLICO_AQUI:5090
listen=udp:0.0.0.0:5080 advertise SEU_IP_PUBLICO_AQUI:5080
listen=tcp:0.0.0.0:5080 advertise SEU_IP_PUBLICO_AQUI:5080

# ✅ IMPORTANTE: Substitua pelos seus IPs
alias=SEU_IP_PUBLICO_AQUI:5060
alias=SEU_IP_PUBLICO_AQUI:5080
alias=SEU_IP_PUBLICO_AQUI:5090

#!ifdef WITH_TLS
enable_tls=yes
tls_max_connections=2048
tls_threads_mode=2
#!endif

enable_sctp=no

####### Modules Section ########
#!ifdef WITH_TLS
loadmodule "tls.so"
#!endif
#!ifdef WITH_MYSQL
loadmodule "db_mysql.so"
#!endif
#!ifdef WITH_JSONRPC
loadmodule "xhttp.so"
#!endif
loadmodule "jsonrpcs.so"
loadmodule "kex.so"
loadmodule "corex.so"
loadmodule "tm.so"
loadmodule "tmx.so"
loadmodule "sl.so"
loadmodule "rr.so"
loadmodule "pv.so"
loadmodule "maxfwd.so"
loadmodule "usrloc.so"
loadmodule "registrar.so"
loadmodule "textops.so"
loadmodule "textopsx.so"
loadmodule "siputils.so"
loadmodule "xlog.so"
loadmodule "sanity.so"
loadmodule "ctl.so"
loadmodule "cfg_rpc.so"
loadmodule "acc.so"
loadmodule "counters.so"
loadmodule "dlgs.so"
loadmodule "dispatcher.so"
loadmodule "db_postgres.so"
loadmodule "sqlops.so"
loadmodule "cfgutils.so"
loadmodule "async.so"

# ✅ OTIMIZAÇÃO: Módulo Dialog Adicionado
loadmodule "dialog.so"

#!ifdef WITH_AUTH
loadmodule "auth.so"
loadmodule "auth_db.so"
#!ifdef WITH_IPAUTH
loadmodule "permissions.so"
#!endif
#!endif

#!ifdef WITH_ALIASDB
loadmodule "alias_db.so"
#!endif
#!ifdef WITH_SPEEDDIAL
loadmodule "speeddial.so"
#!endif
#!ifdef WITH_MULTIDOMAIN
loadmodule "domain.so"
#!endif
#!ifdef WITH_PRESENCE
loadmodule "presence.so"
loadmodule "presence_xml.so"
#!endif

#!ifdef WITH_NAT
loadmodule "nathelper.so"
#!ifdef WITH_RTPENGINE
loadmodule "rtpengine.so"
#!else
loadmodule "rtpproxy.so"
#!endif
#!endif

#!ifdef WITH_HTABLE
loadmodule "htable.so"
#!endif
#!ifdef WITH_ANTIFLOOD
loadmodule "pike.so"
#!endif
#!ifdef WITH_DEBUG
loadmodule "debugger.so"
#!endif

loadmodule "sdpops.so"
loadmodule "uac.so"

####### MODULE PARAMETERS #########

# ✅ IMPORTANTE: Ajuste a string de conexão PostgreSQL
# Formato: postgres://USUARIO:SENHA@HOST/BANCO
# Substitua:
#   - USUARIO: Usuário do PostgreSQL (ex: asterisk, asbc_user)
#   - SENHA: Senha do usuário
#   - HOST: Endereço do servidor (geralmente localhost)
#   - BANCO: Nome do banco de dados (ex: asterisk, asbc)
modparam("sqlops", "sqlcon", "pc=>postgres://USUARIO:SENHA@localhost/BANCO")

# UAC
modparam("uac", "restore_mode", "auto")
modparam("uac", "restore_dlg", 1)

# Dispatcher
modparam("dispatcher", "list_file", "/etc/kamailio/dispatcher.list")

# JSONRPC
modparam("jsonrpcs", "pretty_format", 1)
#!ifdef WITH_JSONRPC
modparam("jsonrpcs", "transport", 7)
#!endif

# Sanity
modparam("sanity", "autodrop", 0)

# TM
modparam("tm", "failure_reply_mode", 3)
modparam("tm", "fr_timer", 30000)
modparam("tm", "fr_inv_timer", 120000)

# RR
modparam("rr", "enable_full_lr", 0)
modparam("rr", "append_fromtag", 0)

# DLGS
modparam("dlgs", "timer_interval", 10)
modparam("dlgs", "init_lifetime", 180)
modparam("dlgs", "active_lifetime", 7200)
modparam("dlgs", "finish_lifetime", 10)

# Registrar
modparam("registrar", "method_filtering", 1)
modparam("registrar", "max_expires", 3600)
modparam("registrar", "gruu_enabled", 0)
modparam("registrar", "use_path", 1)
modparam("registrar", "path_mode", 0)

# ACC
modparam("acc", "early_media", 0)
modparam("acc", "report_ack", 0)
modparam("acc", "report_cancels", 0)
modparam("acc", "detect_direction", 0)
modparam("acc", "log_flag", FLT_ACC)
modparam("acc", "log_missed_flag", FLT_ACCMISSED)
modparam("acc", "log_extra",
        "src_user=$fU;src_domain=$fd;src_ip=$si;"
        "dst_ouser=$tU;dst_user=$rU;dst_domain=$rd")
modparam("acc", "failed_transaction_flag", FLT_ACCFAILED)

# Usrloc
modparam("usrloc", "timer_interval", 60)
modparam("usrloc", "timer_procs", 1)
modparam("usrloc", "use_domain", MULTIDOMAIN)

# ✅ OTIMIZAÇÃO: Configuração do Dialog
modparam("dialog", "enable_stats", 1)
modparam("dialog", "hash_size", 4096)
modparam("dialog", "default_timeout", 43200)
modparam("dialog", "track_cseq_updates", 1)

# RTPEngine
#!ifdef WITH_NAT
#!ifdef WITH_RTPENGINE
modparam("rtpengine", "rtpengine_sock", "udp:127.0.0.1:2223")
#!else
modparam("rtpproxy", "rtpproxy_sock", "udp:127.0.0.1:7722")
#!endif
modparam("nathelper", "natping_interval", 30)
modparam("nathelper", "ping_nated_only", 1)
modparam("nathelper", "sipping_bflag", FLB_NATSIPPING)
modparam("nathelper", "sipping_from", "sip:pinger@kamailio.org")
modparam("nathelper|registrar", "received_avp", "$avp(RECEIVED)")
modparam("usrloc", "nat_bflag", FLB_NATB)
#!endif

# Pike (Anti-flood) - Ajustado conforme diretrizes
#!ifdef WITH_ANTIFLOOD
modparam("pike", "sampling_time_unit", 1)
modparam("pike", "reqs_density_per_unit", 5) # Mais restritivo
modparam("pike", "remove_latency", 2)
#!endif

# HTables
#!ifdef WITH_HTABLE
modparam("htable", "htable", "call=>size=14;autoexpire=7200;")
modparam("htable", "htable", "cust_chan=>size=12;autoexpire=43200;")
modparam("htable", "htable", "carr_chan=>size=12;autoexpire=43200;")
modparam("htable", "htable", "active_channels=>size=12;autoexpire=3600;")
# ✅ OTIMIZAÇÃO: Cache de DID e Rate Limit
modparam("htable", "htable", "did_cache=>size=12;autoexpire=600;")
modparam("htable", "htable", "cps_limit=>size=10;autoexpire=60;")

#!ifdef WITH_ANTIFLOOD
modparam("htable", "htable", "ipban=>size=8;autoexpire=300;")
#!endif
#!endif

#!ifdef WITH_DEBUG
modparam("debugger", "cfgtrace", 1)
modparam("debugger", "log_level_name", "exec")
#!endif

####### INCLUDES #########
include_file "base-routes.cfg"
include_file "calls-in.cfg"
include_file "calls-out.cfg"
include_file "calls-audio.cfg"
